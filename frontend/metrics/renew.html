<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Metrics · AI Experiment Tracker</title>
    <style>
        :root { --bg:#f6f7fb; --panel:#fff; --ink:#111827; --muted:#6b7280; --brand:#0f2b5b; --brand-weak:#183a78; --radius:16px; --shadow:0 10px 18px rgba(18,28,45,.08) }
        *{ box-sizing:border-box }
        body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans KR"; color:var(--ink); background:var(--bg) }

        /* Header */
        header{ background:linear-gradient(180deg,#0f2b5b,#183a78); color:#fff; padding:14px 20px; font-weight:800; text-align:center }

        /* Layout with sidebar */
        .layout{ max-width:1280px; margin:0 auto; padding:18px; display:grid; gap:18px; grid-template-columns:240px 1fr; }
        @media (max-width:980px){ .layout{ grid-template-columns:1fr } .sidebar{ order:2 } }

        /* Sidebar nav */
        .sidebar{ background:var(--panel); border-radius:16px; box-shadow:var(--shadow); padding:16px; border:1px solid #eef1f7; height:fit-content; }
        .sidebar h2{ font-size:12px; color:var(--muted); margin:0 0 10px; letter-spacing:.6px }
        .nav{ list-style:none; padding:0; margin:0; display:grid; gap:6px }
        .nav a{ display:block; padding:10px 12px; border-radius:12px; text-decoration:none; color:var(--ink) }
        .nav a:hover{ background:#f0f4ff }
        .nav a.is-active{ background:#e6edff; font-weight:700 }

        .main { display: grid; gap: 16px; }

        /* Cards & controls */
        .card{ background:var(--panel); border-radius:16px; box-shadow:var(--shadow); padding:16px; border:1px solid #eef1f7 }
        .row{ display:grid; gap:10px; grid-template-columns: 1fr 160px; }
        @media (max-width:720px){ .row{ grid-template-columns:1fr } }
        label{ font-size:12px; color:var(--muted) }
        input,select,button{ padding:10px 12px; border:1px solid #dee3ef; border-radius:12px; font:inherit; background:#fff }
        input,select{ width:100% }
        button{ background:#111827; color:#fff; font-weight:700; border:none; cursor:pointer; white-space:nowrap }
        .hint{ color:var(--muted); font-size:12px; margin:8px 0 0 }

        /* Table */
        table{ width:100%; border-collapse:collapse }
        th,td{ padding:8px 10px; border-bottom:1px solid #eef1f7; text-align:left; vertical-align:top }
        th{ font-size:12px; color:var(--muted) }

        /* Utils */
        .flex{ display:flex; gap:8px; align-items:center }
        .right{ margin-left:auto }
        .empty{ color:var(--muted) }
    </style>
</head>
<body>
<header>Metrics</header>

<main class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>MENU</h2>
        <ul class="nav">
            <li><a href="/index">Home</a></li>
            <li><a href="/projects">Projects</a></li>
            <li><a href="/experiments">Experiments</a></li>
            <li><a href="/runs">Runs</a></li>
        </ul>
    </aside>

    <!-- Main content -->
    <section class="main">
        <section class="card">
            <h3 style="margin:0 0 10px">Metrics Explorer</h3>
            <p id="ctx" class="hint"></p>
            <p id="hint" class="hint"></p>
            <div class="row">
                <input id="key" placeholder="metric key (e.g. train/loss)" />
                <button id="load">Load</button>
            </div>
        </section>

        <section class="card">
            <div class="flex">
                <h3 style="margin:0">Results</h3>
                <button id="back" class="right">← Back to Runs</button>
            </div>
            <table>
                <thead><tr><th>step</th><th>key</th><th>value</th><th>recordedAt</th></tr></thead>
                <tbody id="tbody"><tr><td colspan="4" class="empty">데이터 없음</td></tr></tbody>
            </table>
            <canvas id="chart" height="220" style="width:100%; max-height:280px; margin-top:12px"></canvas>
        </section>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const API = localStorage.getItem('apiBase') || 'http://localhost:8080/api';
    const auth = ()=> { const b=localStorage.getItem('basicAuth'); return b? {Authorization:'Basic '+b}:{ } };
    const qs = s => document.querySelector(s);
    const sp = new URLSearchParams(location.search);

    const runId = sp.get('runId');
    const projectIdQ = sp.get('projectId');
    const experimentIdQ = sp.get('experimentId');

    // 컨텍스트 표시
    (function initCtx(){
      const ctx = [];
      ctx.push(`runId=${runId || '(none)'}`);
      if(projectIdQ) ctx.push(`projectId=${projectIdQ}`);
      if(experimentIdQ) ctx.push(`experimentId=${experimentIdQ}`);
      qs('#ctx').textContent = ctx.join('  •  ');
    })();

    async function jget(url){ const r=await fetch(url,{headers:{...auth()}}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

    async function listMetrics(rid, key){
      const q = new URLSearchParams({ page:0, size:500 });
      if(key) q.set('key', key);
      q.append('sort','step,ASC');
      q.append('sort','recordedAt,ASC');
      const j = await jget(`${API}/runs/${rid}/metrics?${q.toString()}`);
      return j?.data?.content ?? [];
    }

    function firstKey(rows){
      const ks = [...new Set(rows.map(m=>m.key))];
      return ks.length ? ks.sort()[0] : '';
    }

    function render(rows){
      const $ = qs('#tbody');
      if(!rows.length){ $.innerHTML = '<tr><td colspan="4" class="empty">데이터 없음</td></tr>'; return; }
      $.innerHTML = rows.map(m=>`
        <tr>
          <td>${m.step ?? ''}</td>
          <td>${m.key || ''}</td>
          <td>${m.value ?? ''}</td>
          <td>${m.recordedAt || ''}</td>
        </tr>`).join('');
    }

    let chart;
    function drawChart(rows, labelText){
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');
      if (!rows.length){
        if (chart) { chart.destroy(); chart = null; }
        return;
      }
      const data = [...rows].sort((a,b)=>(a.step??0)-(b.step??0) || (a.recordedAt||'').localeCompare(b.recordedAt||''));
      const labels = data.map(r=> r.step ?? '');
      const values = data.map(r=> r.value ?? null);
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label: labelText || 'metric', data: values }] },
        options:{ animation:false, plugins:{legend:{display:true}}, scales:{ x:{title:{display:true,text:'step'}}, y:{beginAtZero:false} } }
      });
    }

    // ✅ Back: 쿼리 없으면 localStorage 보완해 유지
    qs('#back').addEventListener('click', ()=>{
      const pid = projectIdQ || localStorage.getItem('runs.selectedProjectId') || '';
      const eid = experimentIdQ || localStorage.getItem('runs.selectedExperimentId') || '';
      const q = new URLSearchParams();
      if(pid) q.set('projectId', pid);
      if(eid) q.set('experimentId', eid);
      location.href = `/runs?${q.toString()}`;
    });

    // Load 버튼(인풋 기반) + 그래프
    qs('#load').addEventListener('click', async ()=>{
      if(!runId) return alert('runId가 없습니다. Runs에서 Metrics 버튼으로 진입하세요.');
      try{
        qs('#hint').textContent = 'Loading...';
        let key = qs('#key').value.trim();
        // key가 비면 한 번 전체를 가져와 첫 키를 고르고, 다시 해당 키로 재조회
        if (!key){
          const all = await listMetrics(runId, null);
          key = firstKey(all);
          if (!key){
            render([]); drawChart([], '');
            qs('#hint').textContent = '완료 (표시할 키가 없습니다)';
            return;
          }
        }
        const rows = await listMetrics(runId, key);
        render(rows);
        drawChart(rows, key);
        qs('#hint').textContent = `완료: ${rows.length} rows`;
      }catch(e){
        console.error(e);
        qs('#hint').textContent = '불러오기 실패: ' + (e.message||'error');
      }
    });

    // 편의: runId가 있으면 자동 로드
    if (runId) {
      qs('#load').click();
    }
</script>
</body>
</html>